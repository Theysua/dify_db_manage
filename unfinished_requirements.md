# Dify 企业版客户全生命周期管理平台 (DSMS)

![Dify Sales Management System](https://path.to/logo.png)

一个为Dify企业产品设计的全面的企业许可证生命周期管理平台，旨在优化商机管理、合作伙伴协作及财务对账流程。

> **最新更新 (2025-03-26)**: 
> - 优化了合作伙伴下单流程
> - 扩展了销售代表和工程师的数据访问权限
> - 修复了合作伙伴API端点的响应验证错误
> - 新增商机管理模块基础功能

## 系统概述

Dify企业版客户全生命周期管理平台是一个以"许可证ID"为核心业务实体的管理系统，建立了完整的许可证生命周期跟踪和管理流程。系统确保客户和许可证之间的清晰层次关系，精确的基于角色的访问控制，以及标准化的业务流程。

该平台集成了商机管理、订单处理、财务对账以及客户生命周期管理的全面解决方案，帮助公司更有效地管理客户关系和业务增长。

## 关键特性

### 已完成功能

#### 许可证生命周期管理

系统全面追踪许可证的以下状态：

1. **创建** - 记录许可证的创建和订单日期
2. **部署** - 跟踪许可证的部署状态和完成情况
3. **使用中** - 监控实际工作空间和用户，对超额使用发出警报
4. **续订/升级** - 记录所有购买、续订和升级交易
5. **变更** - 完整的变更历史跟踪
6. **过期** - 监控即将过期或已过期的许可证

#### 核心功能模块

- **许可证管理**: 创建、更新、查看许可证，完整的变更跟踪
- **客户管理**: 维护客户信息及其关联的许可证
- **销售代表管理**: 管理销售代表并跟踪其绩效
- **合作伙伴管理**: 跟踪合作伙伴及其相关订单
- **经销商管理**: 管理经销商及其相关许可证
- **购买记录**: 记录与许可证相关的所有交易
- **部署记录**: 监控许可证的部署过程，包括工程师分配
- **工程师管理**: 管理负责部署的工厂工程师
- **绩效跟踪**: 跟踪销售和部署指标，提供详细统计数据
- **预警系统**: 对即将过期或超额使用的许可证自动发出警报

#### 增强的访问控制

- **销售代表**: 可以查看所有客户信息、许可证、部署记录和工程师信息
- **工程师**: 可以查看所有部署记录、销售代表信息、客户和许可证
- **合作伙伴**: 可以通过专用界面查看自己的订单并管理订单详情

### 开发中功能

#### 商机管理模块 (一期)

- **商机录入功能**: 支持从邮件或其他来源导入商机信息
- **商机状态跟踪**: 跟踪商机状态（新线索、洽谈中、已成单等）
- **销售漏斗展示**: 各阶段商机数量和金额的可视化展示
- **客户存续情况**: 客户和license情况的展示与管理

#### 财务对账模块 (一期)

- **汇款匹配**: 汇款和订单信息的自动匹配
- **发票管理**: 发票状态跟踪功能

### 待开发功能

#### 商机管理扩展 (二期)

- **商机分析**: 商机转化率、销售周期等关键指标的统计和分析
- **销售预测**: 销售趋势分析和预测，支持管理层决策

#### 合作伙伴管理扩展 (二期)

- **合作伙伴绩效分析**: 订单数量、金额、商机数据等
- **合作伙伴培训支持**: 在线培训和支持材料访问功能

#### 高级数据看板 (三期)

- **管理层数据看板**: 商机、订单、财务等关键数据的可视化报告
- **客户健康度分析**: 客户活跃度和流失风险预警功能

## 技术栈

### 后端
- **框架**: FastAPI
- **语言**: Python 3.8+
- **数据库**: MySQL
- **ORM**: SQLAlchemy
- **API文档**: Swagger UI / OpenAPI
- **迁移工具**: Alembic
- **认证**: JWT (JSON Web Tokens)

### 前端
- **框架**: React 18
- **UI库**: Ant Design 5
- **状态管理**: React Hooks
- **路由**: React Router
- **HTTP客户端**: Axios
- **构建工具**: Webpack
- **包管理器**: npm/yarn

### 开发和部署
- **版本控制**: Git
- **CI/CD**: GitHub Actions
- **容器化**: Docker
- **容器编排**: Docker Compose
- **代码质量**: ESLint, Prettier
- **测试工具**: Jest, React Testing Library

## 系统架构

系统采用前后端分离架构，通过RESTful API进行通信。

```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
|  前端应用      |<--->|  后端API       |<--->|   数据库       |
|  React + Antd  |     |    FastAPI     |     |     MySQL      |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
```

### 数据模型关系

以下是系统中的核心数据模型及其关系：

```
+-------------+     +-------------+     +-------------+
|             |     |             |     |             |
|  Customer   |<--->|   License   |<--->|  SalesRep   |
|             |     |             |     |             |
+-------------+     +------+------+     +-------------+
                           |
                           |
           +--------------------------+
           |              |           |
+----------v----+  +------v------+  +-v------------+
|               |  |             |  |              |
|PurchaseRecord |  |DeployRecord |  |  ChangeLog   |
|               |  |             |  |              |
+---------------+  +-------------+  +--------------+
```

```
+-------------+     +-------------+     +-------------+
|             |     |             |     |             |
|  Partner    |---->|    Order    |<--->|  Lead       |
|             |     |             |     |             |
+-------------+     +------+------+     +-------------+
                           |
                           |
                    +------v------+
                    |             |
                    |  OrderItem  |
                    |             |
                    +-------------+
```

```
+----------+     +-----------+     +--------+     +---------+     +--------+
|          |     |           |     |        |     |         |     |        |
| Created  |---->| Deployed  |---->| In Use |---->| Renewed |---->| Expired |
|          |     |           |     |        |     |         |     |        |
+----------+     +-----------+     +--------+     +---------+     +--------+
```

```
+------------+     +------------+     +------------+     +------------+
|            |     |            |     |            |     |            |
| New Lead   |---->| Negotiating|---->| Qualified  |---->| Closed Won |
|            |     |            |     |            |     |            |
+------------+     +------------+     +------------+     +------------+
       |                                                       |
       |                                                       |
       v                                                       v
+------------+                                          +------------+
|            |                                          |            |
| Disqualified|                                         | Closed Lost|
|            |                                          |            |
+------------+                                          +------------+
```

## 安装指南

### 前提条件

- Python 3.8+
- MySQL 5.7+
- Node.js 14+
- npm或yarn

### 后端设置

1. 克隆仓库
   ```bash
   git clone https://github.com/Theysua/dify_db_manage.git
   cd dify_db_manage
   ```

2. 创建并激活虚拟环境
   ```bash
   cd backend
   python -m venv venv
   source venv/bin/activate  # Windows下：.\venv\Scripts\activate
   ```

3. 安装依赖
   ```bash
   pip install -r requirements.txt
   ```

4. 配置环境变量
   ```bash
   cp .env.example .env  # 然后在.env中编辑数据库凭据
   ```

5. 初始化数据库
   ```bash
   alembic upgrade head
   ```

6. 创建测试数据（可选）
   ```bash
   python -m app.db.create_mock_data
   ```

7. 启动后端服务器
   ```bash
   uvicorn app.main:app --reload
   ```

### 前端设置

1. 导航到前端目录
   ```bash
   cd frontend
   ```

2. 安装依赖
   ```bash
   npm install
   # 或
   yarn install
   ```

3. 配置API URL
   ```bash
   cp .env.example .env  # 然后在.env中编辑API URL
   ```

4. 启动开发服务器
   ```bash
   npm start
   # 或
   yarn start
   ```

5. 访问http://localhost:3000的应用程序

## API参考

### 认证

#### 管理员认证
- `POST /api/v1/auth/login`: 管理员登录
- `GET /api/v1/auth/me`: 获取当前管理员信息

#### 合作伙伴认证
- `POST /api/v1/partners/login`: 合作伙伴登录
- `GET /api/v1/partners/me`: 获取当前合作伙伴信息
- `PUT /api/v1/partners/me`: 更新当前合作伙伴信息

### 客户管理

- `GET /api/v1/customers`: 获取客户列表
- `POST /api/v1/customers`: 创建新客户（仅限管理员）
- `GET /api/v1/customers/{customer_id}`: 获取特定客户详情
- `PUT /api/v1/customers/{customer_id}`: 更新客户信息（仅限管理员）
- `DELETE /api/v1/customers/{customer_id}`: 删除客户（仅限管理员）

### 许可证管理

- `GET /api/v1/licenses`: 获取许可证列表
- `POST /api/v1/licenses`: 创建新许可证（仅限管理员）
- `GET /api/v1/licenses/{license_id}`: 获取特定许可证详情
- `PUT /api/v1/licenses/{license_id}`: 更新许可证信息（仅限管理员）
- `DELETE /api/v1/licenses/{license_id}`: 删除许可证（仅限管理员）

### 订单管理

- `GET /api/v1/partners/orders`: 获取合作伙伴订单列表
- `POST /api/v1/partners/orders`: 创建新订单
- `GET /api/v1/partners/orders/{order_id}`: 获取特定订单详情

### 新增API端点（待实现）

#### 商机管理
- `GET /api/v1/leads`: 获取商机列表
- `POST /api/v1/leads`: 创建新商机
- `GET /api/v1/leads/{lead_id}`: 获取特定商机详情
- `PUT /api/v1/leads/{lead_id}`: 更新商机信息
- `PATCH /api/v1/leads/{lead_id}/status`: 更新商机状态
- `DELETE /api/v1/leads/{lead_id}`: 删除商机

#### 财务对账
- `GET /api/v1/payments`: 获取汇款记录列表
- `POST /api/v1/payments`: 创建新汇款记录
- `GET /api/v1/payments/{payment_id}`: 获取特定汇款记录详情
- `PUT /api/v1/payments/{payment_id}`: 更新汇款记录
- `GET /api/v1/invoices`: 获取发票列表
- `POST /api/v1/invoices`: 创建新发票
- `GET /api/v1/invoices/{invoice_id}`: 获取特定发票详情
- `PUT /api/v1/invoices/{invoice_id}/status`: 更新发票状态

### 其他端点

- 销售代表: `/api/v1/sales_reps`
- 经销商: `/api/v1/resellers`
- 购买记录: `/api/v1/purchases`
- 部署记录: `/api/v1/deployments`
- 工厂工程师: `/api/v1/engineers`

运行后端服务器时，完整的API文档可在http://localhost:8000/docs获取。

## 项目结构

```
dify_sales_db/
├── backend/
│   ├── app/
│   │   ├── api/
│   │   │   └── v1/
│   │   │       ├── endpoints/             # API端点
│   │   │       │   ├── licenses.py        # 许可证API
│   │   │       │   ├── customers.py       # 客户API
│   │   │       │   ├── sales_reps.py      # 销售代表API
│   │   │       │   ├── resellers.py       # 经销商API
│   │   │       │   ├── purchases.py       # 购买记录API
│   │   │       │   ├── deployments.py     # 部署记录API
│   │   │       │   ├── stats.py           # 统计API
│   │   │       │   ├── engineers.py       # 工程师API
│   │   │       │   ├── leads.py           # 商机API(待实现)
│   │   │       │   ├── payments.py        # 汇款记录API(待实现)
│   │   │       │   └── invoices.py        # 发票API(待实现)
│   │   │       └── api.py                 # API路由注册
│   │   ├── core/                          # 核心配置
│   │   │   ├── config.py                  # 系统配置
│   │   │   └── security.py                # 安全相关
│   │   ├── db/                            # 数据库相关
│   │   │   └── database.py                # 数据库连接
│   │   ├── models/                        # 数据模型
│   │   │   ├── license.py                 # 许可证模型
│   │   │   ├── customer.py                # 客户模型
│   │   │   ├── order.py                   # 订单模型
│   │   │   ├── lead.py                    # 商机模型(待实现)
│   │   │   ├── payment.py                 # 汇款模型(待实现)
│   │   │   └── invoice.py                 # 发票模型(待实现)
│   │   ├── schemas/
│   │   │   ├── license.py                 # 许可证模式
│   │   │   ├── customer.py                # 客户模式
│   │   │   ├── order.py                   # 订单模式
│   │   │   ├── lead.py                    # 商机模式(待实现)
│   │   │   ├── payment.py                 # 汇款模式(待实现)
│   │   │   └── invoice.py                 # 发票模式(待实现)
│   │   ├── services/
│   │   │   ├── license_service.py
│   │   │   ├── customer_service.py
│   │   │   ├── sales_rep_service.py
│   │   │   ├── reseller_service.py
│   │   │   ├── purchase_service.py
│   │   │   ├── deployment_service.py
│   │   │   ├── engineer_service.py
│   │   │   ├── lead_service.py           # 商机服务(待实现)
│   │   │   ├── payment_service.py        # 汇款服务(待实现)
│   │   │   └── invoice_service.py        # 发票服务(待实现)
│   │   └── main.py
│   ├── alembic/
│   └── requirements.txt
├── frontend/
│   ├── public/
│   │   ├── index.html
│   │   └── manifest.json
│   ├── src/
│   │   ├── components/
│   │   │   └── layouts/
│   │   │       └── MainLayout.js
│   │   ├── pages/
│   │   │   ├── customers/
│   │   │   ├── deployments/
│   │   │   ├── engineers/
│   │   │   ├── licenses/
│   │   │   ├── leads/                     # 商机页面(待实现)
│   │   │   ├── finances/                  # 财务页面(待实现)
│   │   │   ├── Dashboard.js
│   │   │   └── NotFound.js
│   │   ├── services/
│   │   │   └── api.js
│   │   ├── utils/
│   │   │   ├── connectionCheck.js
│   │   │   ├── errorHandler.js
│   │   │   └── formatters.js
│   │   ├── App.js
│   │   ├── config.js
│   │   └── index.js
│   ├── package.json
│   ├── README.md
│   └── setup.sh
└── README.md

3.1 一期目标交付物
1. 合作伙伴下单流程：
  - 数字化下单功能，合作伙伴可直接通过平台提交订单，无需线下盖章。
  - 经过后台管理员核准，自动生成license key并发送给合作伙伴或客户。
2. 商机管理：
  - 商机录入功能，支持从邮件或其他来源导入商机信息。
  - 商机状态跟踪（如新线索、洽谈中、已成单等）。
  - 简单的销售漏斗展示（如各阶段商机数量和金额）。
  - 客户存续情况和 license 情况展示与管理。
3. 财务对账功能：
  - 汇款和订单信息的自动匹配，提高财务对账效率。
  - 提供发票状态跟踪功能，减少发票管理混乱的问题。


## 项目进度和未完成功能状态报告

> **状态更新日期**: 2025-03-26

### 当前开发状态概览

根据项目规划和当前进度，以下功能已完成或正在进行中：

- ✅ 核心客户与许可证管理系统
- ✅ 增强型基于角色的访问控制
- ✅ 合作伙伴下单流程优化
- 🔄 商机管理模块（一期）
- 🔄 财务对账模块（一期）
- ⏳ 商机管理扩展（二期）
- ⏳ 合作伙伴管理扩展（二期）
- ⏳ 高级数据看板（三期）

### 开发中功能（正在进行）

#### 1. 商机管理模块（一期）

| 功能 | 状态 | 预计完成时间 | 技术细节 |
|------|------|------------|---------|
| **商机录入功能** | 开发中 | Q2 2025 | 需支持REST API导入和UI手动录入，包含数据验证逻辑 |
| **商机状态跟踪** | 开发中 | Q2 2025 | 实现状态转换逻辑、触发器和事件通知 |
| **销售漏斗展示** | 规划中 | Q2 2025 | 使用Ant Design图表组件，需连接到商机数据API |
| **客户存续展示** | 规划中 | Q2 2025 | 整合license数据与客户数据，生成状态报告 |

**技术实现要点**:
- 需新增数据模型：`Lead`、`LeadStatus`、`LeadSource`
- 前端需添加商机管理页面与相关组件
- 后端需实现以下API端点：
  ```
  POST /api/v1/leads
  GET /api/v1/leads
  GET /api/v1/leads/{lead_id}
  PUT /api/v1/leads/{lead_id}
  PATCH /api/v1/leads/{lead_id}/status
  DELETE /api/v1/leads/{lead_id}
  ```

#### 2. 财务对账模块（一期）

| 功能 | 状态 | 预计完成时间 | 技术细节 |
|------|------|------------|---------|
| **汇款匹配** | 开发中 | Q2 2025 | 支持手动匹配和自动匹配算法 |
| **发票管理** | 开发中 | Q2 2025 | 完整发票状态生命周期跟踪 |

**技术实现要点**:
- 需新增数据模型：`Invoice`、`Payment`、`PaymentMatch`
- 前端需添加财务对账界面与发票管理组件
- 后端需实现匹配算法与相关API端点

### 待开发功能（未开始）

#### 1. 商机管理扩展（二期）

| 功能 | 预计开始时间 | 预计完成时间 | 依赖项 |
|------|------------|------------|-------|
| **商机分析** | Q3 2025 | Q4 2025 | 商机管理模块一期 |
| **销售预测** | Q3 2025 | Q4 2025 | 商机管理模块一期 |

**技术实现要点**:
- 统计分析API设计
- 时间序列预测算法选型与实现
- 报表生成逻辑与前端展示组件

#### 2. 合作伙伴管理扩展（二期）

| 功能 | 预计开始时间 | 预计完成时间 | 依赖项 |
|------|------------|------------|-------|
| **合作伙伴绩效分析** | Q3 2025 | Q4 2025 | 合作伙伴基础模块 |
| **合作伙伴培训支持** | Q3 2025 | Q4 2025 | - |

**技术实现要点**:
- 绩效指标数据收集模块
- 培训内容管理系统设计
- 访问权限控制与内容分发逻辑

#### 3. 高级数据看板（三期）

| 功能 | 预计开始时间 | 预计完成时间 | 依赖项 |
|------|------------|------------|-------|
| **管理层数据看板** | Q1 2026 | Q2 2026 | 商机管理、财务对账模块 |
| **客户健康度分析** | Q1 2026 | Q2 2026 | 许可证使用数据收集API |

**技术实现要点**:
- 设计集成数据模型
- 实现多维度数据分析逻辑
- 开发交互式数据可视化组件

### 近期技术进展

1. **合作伙伴下单流程优化**
   - 改进了订单表单验证逻辑
   - 简化了多产品选择流程
   - 增强了价格计算准确性

2. **角色权限控制优化**
   - 扩展了销售代表的数据访问范围（所有客户、许可证、部署记录和工程师信息）
   - 扩展了工程师的数据访问范围（所有部署记录、销售代表、客户和许可证信息）
   - 实现了新的权限控制架构，保持修改操作的严格审批

3. **API端点优化**
   - 修复了合作伙伴API的响应验证错误
   - 改进了错误处理和异常报告
   - 优化了API性能和响应时间

4. **商机管理基础功能**
   - 完成了数据模型设计
   - 实现了核心API端点
   - 开发了基础UI组件

### 开发计划与里程碑

| 里程碑 | 计划完成日期 | 包含功能 |
|-------|------------|---------|
| **MVP 1.0** | Q2 2025 | 商机管理（一期）、财务对账（一期） |
| **Version 2.0** | Q4 2025 | 商机管理扩展、合作伙伴管理扩展 |
| **Version 3.0** | Q2 2026 | 高级数据看板 |

本开发状态文档将定期更新以反映项目最新进展。