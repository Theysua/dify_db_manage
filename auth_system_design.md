# Dify合作伙伴管理系统 - 认证系统设计

## 1. 概述

本文档描述了Dify合作伙伴管理系统的认证系统设计，包括管理员和合作伙伴的登录流程、权限控制和安全措施。

## 2. 用户角色

系统包含以下用户角色：

1. **系统管理员**：拥有所有功能的访问权限，可以管理合作伙伴、订单和系统设置。
2. **合作伙伴**：只能访问自己的信息和订单，提交新订单。
3. **销售代表**：可以查看客户、许可证和部署信息，有限的修改权限。
4. **工程师**：可以查看部署相关信息，有限的修改权限。

## 3. 认证流程

### 3.1 登录流程

1. 用户访问登录页面，输入用户名和密码。
2. 前端将凭据发送到后端API。
3. 后端验证凭据，如果有效，生成JWT（JSON Web Token）。
4. 前端存储JWT（localStorage/sessionStorage）并在后续请求中包含该令牌。
5. 后端验证每个受保护路由的JWT。

### 3.2 令牌结构

JWT包含以下主要字段：

- `sub`：用户名
- `user_id`：用户ID
- `partner_id`：如果是合作伙伴，则包含合作伙伴ID
- `scopes`：权限范围数组，如 ["admin"]、["partner"]
- `exp`：过期时间
- `iat`：颁发时间

### 3.3 令牌管理

- 访问令牌有效期：7天
- 前端处理令牌过期：重定向到登录页面
- 自动续签：暂不实现，后续可考虑刷新令牌机制

## 4. API端点

### 4.1 认证接口

- `POST /api/v1/auth/login`：登录接口
  - 请求体：`{ "username": "string", "password": "string" }`
  - 响应：`{ "access_token": "string", "token_type": "bearer", "user_info": {} }`

- `POST /api/v1/auth/logout`：登出接口（前端删除令牌）

### 4.2 受保护接口

所有管理接口都需要有效的管理员JWT：
- `/api/v1/admin/*`

合作伙伴接口需要有效的合作伙伴JWT：
- `/api/v1/partners/*`

## 5. 前端实现

### 5.1 登录组件

- 创建登录页面，包含用户名和密码输入
- 处理登录逻辑和错误提示
- 登录成功后存储令牌并重定向到合适的页面

### 5.2 API请求拦截

- 配置axios拦截器，自动为每个请求添加Authorization头
- 处理401响应，重定向回登录页

### 5.3 权限控制

- 基于用户角色控制导航菜单项的显示
- 实现受保护路由，未登录用户无法访问

## 6. 安全考虑

- 使用HTTPS保护所有通信
- 密码存储使用bcrypt加密
- 实施合理的密码策略（长度、复杂度）
- 实施速率限制，防止暴力攻击
- 令牌过期机制
- 考虑CSRF保护

## 7. 实现计划

1. 创建后端认证模块和API端点
2. 实现前端登录页面和组件
3. 配置API请求拦截器
4. 实现导航和路由保护
5. 测试不同角色的访问控制
